<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie-edge">
    <title>Training Error Plot</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js'></script>
</head>
<body>
    <div style="width: 100%; display: table;">
        <div style="display: table-row">
            <div style="width: 600px; display: table-cell;">
                <select id="selectXFeature">
                    <option>Choose x feature</option>
                </select>
            </div>
            <div style="width: 600px; display: table-cell;">
                <select id="selectYFeature">
                    <option>Choose y feature</option>
                </select>
            </div>
            <div style="width: 600px; display: table-cell;">
                    <select id="selectZFeature">
                    <option>Choose z feature</option>
                </select>
                <input id="plotme" type="button" value="plot"></input>
            </div>
        </div>
        <div style="display: table-row">
            <div id="plotxy" style="width: 600px; height: 600px; display: table-cell;"></div>
            <div id="plotyz" style="width: 600px; height: 600px; display: table-cell;"></div>
            <div id="plotxz" style="width: 600px; height: 600px; display: table-cell;"></div>
        </div>
        <div style="display: table-row">
            <div style="width: 600px; display: table-cell;">
                <select id="selectX2Feature">
                    <option>Choose x feature</option>
                </select>
            </div>
            <div style="width: 600px; display: table-cell;">
                <select id="selectY2Feature">
                    <option>Choose y feature</option>
                </select>
            </div>
            <div style="width: 600px; display: table-cell;">
                    <select id="selectZ2Feature">
                    <option>Choose z feature</option>
                </select>
                <input id="plotme2" type="button" value="plot"></input>
            </div>
        </div>
        <div style="display: table-row">
            <div id="plotxy2" style="width: 600px; height: 600px; display: table-cell;"></div>
            <div id="plotyz2" style="width: 600px; height: 600px; display: table-cell;"></div>
            <div id="plotxz2" style="width: 600px; height: 600px; display: table-cell;"></div>
        </div>
    </div>
    <script>
        function unpack(rows, key) {
            return rows.map(function (row) {
                return row[key];
            });
        }
        function unpackSize(rows, key) {
            return rows.map(function(row){
                return row[key] + 6; 
            });
        }
        function unpackClassColor(rows) {
            return rows.map(function(row) {
                if (row['class'] == -2) {
                    return 'rgba(217,217,240, 0.14)'
                }
                if (row['class'] == 0) {
                    return 'rgba(0,240,0, 0.14)'
                }
                if (row['class'] == 1) {
                    return 'rgba(240,0,0, 0.14)'
                }
            })
        }

        function plotdata(dest,nx,x,ny,y,nsz,sz, clz, clzcolors) {
            var data = [{
                x: x,
                y: y,
                text: clz,
                mode: 'markers',
                marker: {
                    size: sz,
                    line: {
                        colors: clzcolors,
                        width: 0.5
                    },
                    opacity: 0.8
                },
                transforms: [{ type: "groupby", groups: clz}],
                hovertemplate: nx + ": %{x}<br>" +
                    ny + ": %{y}<br>" +
                    "Class: %{text}<br>" +
                    nsz + ": %{marker.size}" +
                    "<extra></extra>",
                showlegend: true,
                type: "scatter"
            }];
            var layout = {
                hovermode: 'closest',
                width: 600,
                height: 600,
                title: nx + ' vs. ' + ny + '(' + nsz + ')',
                xaxis: {
                    title: nx 
                },
                yaxis: {
                    title: ny
                },
                config: { responsive: true }
            }
            Plotly.newPlot(dest, data, layout);
        }

        function plotit() {
            var selX = document.getElementById("selectXFeature")
            var selY = document.getElementById("selectYFeature")
            var selZ = document.getElementById("selectZFeature")
            
            if (selX.selectedIndex == 0 || selY.selectedIndex == 0 || selZ.selectedIndex == 0)
                alert("Please select all three columns to plot");
            else {
                colX = selX.options[selX.selectedIndex].value
                colY = selY.options[selY.selectedIndex].value
                colZ = selZ.options[selZ.selectedIndex].value
                clazz = 'class'

                d3.csv('http://localhost:8080/fetchdata', function(err, rows) {
                    var x = unpack(rows, colX)
                    var y = unpack(rows, colY)
                    var z = unpack(rows, colZ)

                    var sizeX = unpackSize(rows, colX)
                    var sizeY = unpackSize(rows, colY)
                    var sizeZ = unpackSize(rows, colZ)

                    var clz = unpack(rows, 'class')
                    var colors = unpackClassColor(rows)
                    plotdata('plotxy', colX, x, colY, y, colZ, sizeZ, clz, colors)
                    plotdata('plotxz', colX, x, colZ, z, colY, sizeY, clz, colors)
                    plotdata('plotyz', colY, y, colZ, z, colX, sizeX, clz, colors)
                });
            }
        }

        function plotit2() {
            var selX = document.getElementById("selectX2Feature")
            var selY = document.getElementById("selectY2Feature")
            var selZ = document.getElementById("selectZ2Feature")
            
            if (selX.selectedIndex == 0 || selY.selectedIndex == 0 || selZ.selectedIndex == 0)
                alert("Please select all three columns to plot");
            else {
                colX = selX.options[selX.selectedIndex].value
                colY = selY.options[selY.selectedIndex].value
                colZ = selZ.options[selZ.selectedIndex].value
                clazz = 'class'

                d3.csv('http://localhost:8080/fetchdata', function(err, rows) {
                    var x = unpack(rows, colX)
                    var y = unpack(rows, colY)
                    var z = unpack(rows, colZ)

                    var sizeX = unpackSize(rows, colX)
                    var sizeY = unpackSize(rows, colY)
                    var sizeZ = unpackSize(rows, colZ)

                    var clz = unpack(rows, 'class')
                    var colors = unpackClassColor(rows)
                    plotdata('plotxy2', colX, x, colY, y, colZ, sizeZ, clz, colors)
                    plotdata('plotxz2', colX, x, colZ, z, colY, sizeY, clz, colors)
                    plotdata('plotyz2', colY, y, colZ, z, colX, sizeX, clz, colors)
                });
            }
        }

        var selectX = document.getElementById("selectXFeature")
        var selectY = document.getElementById("selectYFeature")
        var selectZ = document.getElementById("selectZFeature")
        var selectX2 = document.getElementById("selectX2Feature")
        var selectY2 = document.getElementById("selectY2Feature")
        var selectZ2 = document.getElementById("selectZ2Feature")
        var data = []
        function createOption(opt) {
            var elx = document.createElement("option");
            elx.textContent = opt;
            elx.value = opt;
            return elx
        }
        d3.csv('http://localhost:8080/fetchdata', function(data){
            console.log(Object.keys(data[0]));
            var options = Object.keys(data[0]);
            for (var idx = 0; idx < options.length; idx++) {
                var opt = options[idx];
                selectX.appendChild(createOption(opt));
                selectX2.appendChild(createOption(opt));
                selectY.appendChild(createOption(opt));
                selectY2.appendChild(createOption(opt));
                selectZ.appendChild(createOption(opt));
                selectZ2.appendChild(createOption(opt));
            }

        });
        var b1 = document.getElementById("plotme")
        if (b1.addEventListener)
            b1.addEventListener("click", plotit, false);
        
        var b2 = document.getElementById("plotme2")
        if (b2.addEventListener)
            b2.addEventListener("click", plotit2, false);
        
        
    </script>
</body>
</html>